<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Explorer - CronWatch SIEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

    <style>
        .log-row {
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-row:hover {
            background-color: rgba(255, 255, 255, 0.05) !important;
            transform: translateX(3px);
        }

        .page-link {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
        }

        .page-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .page-item.active .page-link {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: white;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.4);
        }

        .form-control,
        .form-select {
            background-color: rgba(15, 23, 42, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #cbd5e1 !important;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #38bdf8 !important;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2) !important;
        }
    </style>
</head>

<body>
    {% include 'navbar.html' %}
    <div class="container-fluid px-4 py-4"></div>
    <div class="container-fluid px-4 py-4">
        <div class="card glass-panel mb-4"
            style="background: linear-gradient(180deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.9)); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05);">
            <div class="card-header d-flex align-items-center border-0 pt-3 pb-2">
                <i class="fas fa-filter text-primary me-2"></i>
                <span class="text-white fw-bold" style="font-size: 0.8rem; letter-spacing: 0.5px;">LOG FILTERING</span>
            </div>
            <div class="card-body">
                <form action="/logs" method="get" class="row g-3">
                    <input type="hidden" name="page" value="1">

                    <div class="col-md-4">
                        <label class="form-label text-muted small fw-bold">SEARCH KEYWORDS</label>
                        <div class="input-group">
                            <span
                                class="input-group-text bg-transparent border-secondary border-opacity-25 text-muted"><i
                                    class="fas fa-search"></i></span>
                            <input type="text" name="keyword" class="form-control border-start-0 ps-0 text-white"
                                placeholder="Example: sudo, failed, root..."
                                value="{{ request.args.get('keyword', '') }}">
                        </div>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label text-muted small fw-bold">RISK LEVEL</label>
                        <select name="severity" class="form-select text-white">
                            <option value="">All Levels</option>
                            <option value="CRITICAL" {% if request.args.get('severity')=='CRITICAL' %}selected{% endif
                                %}>CRITICAL</option>
                            <option value="WARNING" {% if request.args.get('severity')=='WARNING' %}selected{% endif %}>
                                WARNING</option>
                            <option value="INFO" {% if request.args.get('severity')=='INFO' %}selected{% endif %}>INFO
                            </option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label text-muted small fw-bold">FROM DATE</label>
                        <input type="date" name="start_date" class="form-control text-white"
                            value="{{ request.args.get('start_date', '') }}">
                    </div>

                    <div class="col-md-2">
                        <label class="form-label text-muted small fw-bold">TO DATE</label>
                        <input type="date" name="end_date" class="form-control text-white"
                            value="{{ request.args.get('end_date', '') }}">
                    </div>

                    <div class="col-md-2 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary w-100 fw-bold"
                            style="background-color: #4f46e5; box-shadow: 0 0 15px rgba(79, 70, 229, 0.3);">
                            Filter Logs
                        </button>
                        <a href="/logs" class="btn btn-outline-secondary" title="Reset Filters"
                            style="border-color: rgba(255,255,255,0.1); color: #cbd5e1;">
                            <i class="fas fa-undo"></i>
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 2. SONUÇ TABLOSU (Glass Panel) -->
        <div class="card glass-panel"
            style="background: linear-gradient(180deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.9)); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); min-height: 500px;">
            <div class="card-header d-flex justify-content-between align-items-center border-0 pt-3">
                <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-list-ul text-primary"></i>
                    <span class="text-white fw-bold" style="font-size: 0.8rem; letter-spacing: 0.5px;">SYSTEM
                        EVENTS</span>
                </div>
                <span class="badge rounded-pill"
                    style="background: rgba(255,255,255,0.05); color: #cbd5e1; border: 1px solid rgba(255,255,255,0.1);">
                    {{ total_count }} Records Found
                </span>
            </div>

            <div class="card-body p-0 mt-2">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="color: #cbd5e1;">
                        <thead style="background: rgba(0,0,0,0.2);">
                            <tr>
                                <th scope="col" class="ps-4 text-muted small text-uppercase"
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600;">#</th>
                                <th scope="col" class="text-muted small text-uppercase"
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600;">Timestamp
                                </th>
                                <th scope="col" class="text-muted small text-uppercase"
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600;">Severity
                                </th>
                                <th scope="col" class="text-muted small text-uppercase"
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600;">Source
                                </th>
                                <th scope="col" class="text-muted small text-uppercase"
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600;">User</th>
                                <th scope="col" class="text-muted small text-uppercase"
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600;">Type</th>
                                <th scope="col" class="text-muted small text-uppercase"
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600;">Message
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in events %}
                            <tr class="log-row">
                                <td class="ps-4 text-muted font-monospace small"
                                    style="border-bottom: 1px solid rgba(255,255,255,0.05);">{{ event.id }}</td>
                                <td class="text-muted small"
                                    style="white-space: nowrap; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    {{ event.timestamp }}
                                </td>
                                <td style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    {% if event.severity == 'CRITICAL' %}
                                    <span class="badge"
                                        style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.4); box-shadow: 0 0 8px rgba(239, 68, 68, 0.2);">CRITICAL</span>
                                    {% elif event.severity == 'WARNING' %}
                                    <span class="badge"
                                        style="background: rgba(250, 204, 21, 0.15); color: #facc15; border: 1px solid rgba(250, 204, 21, 0.3);">WARNING</span>
                                    {% elif event.severity == 'INFO' %}
                                    <span class="badge"
                                        style="background: rgba(14, 165, 233, 0.15); color: #38bdf8; border: 1px solid rgba(14, 165, 233, 0.3);">INFO</span>
                                    {% else %}
                                    <span class="badge"
                                        style="background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3);">{{
                                        event.severity }}</span>
                                    {% endif %}
                                </td>
                                <td class="font-monospace small"
                                    style="color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.05);">{{
                                    event.source }}</td>
                                <td class="fw-bold small text-white"
                                    style="border-bottom: 1px solid rgba(255,255,255,0.05);">{{ event.username }}</td>
                                <td style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <span class="badge"
                                        style="background: rgba(255,255,255,0.05); color: #cbd5e1; border: 1px solid rgba(255,255,255,0.1);">{{
                                        event.event_type }}</span>
                                </td>
                                <td class="text-truncate small"
                                    style="max-width: 350px; color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.05);"
                                    title="{{ event.message }}">
                                    {{ event.message }}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <div class="d-flex flex-column align-items-center opacity-50">
                                        <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                                        <h6 class="text-muted">No logs found matching your criteria.</h6>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {% if total_pages > 1 %}
            <div class="card-footer py-3 border-0">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

                    <div class="small text-muted">
                        Page <span class="text-white fw-bold">{{ current_page }}</span> of {{ total_pages }}
                    </div>

                    <nav aria-label="Page navigation">
                        <ul class="pagination mb-0 justify-content-center">

                            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                                <a class="page-link"
                                    href="{{ url_for('logs_page', page=current_page-1, keyword=request.args.get('keyword'), severity=request.args.get('severity'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date')) }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>

                            {% for p in range(1, total_pages + 1) %}
                            {% if p == 1 or p == total_pages or (p >= current_page - 2 and p <= current_page + 2) %} <li
                                class="page-item {% if p == current_page %}active{% endif %}">
                                <a class="page-link"
                                    href="{{ url_for('logs_page', page=p, keyword=request.args.get('keyword'), severity=request.args.get('severity'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date')) }}">
                                    {{ p }}
                                </a>
                                </li>
                                {% elif p == current_page - 3 or p == current_page + 3 %}
                                <li class="page-item disabled"><span
                                        class="page-link border-0 bg-transparent text-muted">...</span></li>
                                {% endif %}
                                {% endfor %}

                                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                                    <a class="page-link"
                                        href="{{ url_for('logs_page', page=current_page+1, keyword=request.args.get('keyword'), severity=request.args.get('severity'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date')) }}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                        </ul>
                    </nav>

                    <form action="/logs" method="get" class="d-flex align-items-center" style="max-width: 130px;">
                        <input type="hidden" name="keyword" value="{{ request.args.get('keyword', '') }}">
                        <input type="hidden" name="severity" value="{{ request.args.get('severity', '') }}">
                        <input type="hidden" name="start_date" value="{{ request.args.get('start_date', '') }}">
                        <input type="hidden" name="end_date" value="{{ request.args.get('end_date', '') }}">

                        <input type="number" name="page"
                            class="form-control form-control-sm me-1 text-center bg-transparent text-white border-secondary"
                            placeholder="Go" min="1" max="{{ total_pages }}" required>
                        <button type="submit" class="btn btn-sm btn-outline-secondary border-secondary text-white">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </form>

                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <footer class="text-center py-4 text-muted small opacity-50">
        CronWatch Personal Edition &copy; 2025
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            setInterval(function () {
                fetch('/api/live-stats')
                    .then(response => response.json())
                    .then(data => {
                        const uptimeEl = document.getElementById('nav-uptime');
                        if (uptimeEl && data.uptime) {
                            uptimeEl.innerText = data.uptime;
                        }

                        const lastScanEl = document.getElementById('nav-last-scan');
                        if (lastScanEl && data.last_scan) {
                            lastScanEl.innerText = data.last_scan;
                        }
                    })
                    .catch(err => console.error("Veri güncellenemedi:", err));
            }, 1000);

        });
    </script>

</body>

</html>